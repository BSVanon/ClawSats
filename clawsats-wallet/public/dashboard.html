<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClawSats Dashboard</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --border: #30363d;
    --text: #e6edf3; --muted: #8b949e; --accent: #e63946;
    --green: #3fb950; --yellow: #d29922; --red: #f85149; --blue: #58a6ff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
  .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

  /* Header */
  .header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
  .header h1 { font-size: 1.4rem; font-weight: 600; }
  .header h1 span { color: var(--accent); }
  .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
  .status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.offline { background: var(--red); }
  .header-right { font-size: .85rem; color: var(--muted); }
  #refresh-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: .8rem; margin-left: 8px; }
  #refresh-btn:hover { border-color: var(--accent); }

  /* Stats grid */
  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; }
  .stat-num { font-size: 1.8rem; font-weight: 700; color: var(--accent); }
  .stat-label { font-size: .8rem; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; }

  /* Sections */
  .section { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
  .section h2 { font-size: 1rem; font-weight: 600; margin-bottom: .75rem; display: flex; align-items: center; gap: .5rem; }
  .section h2 .icon { font-size: 1.1rem; }

  /* Tables */
  table { width: 100%; border-collapse: collapse; font-size: .85rem; }
  th { text-align: left; color: var(--muted); font-weight: 500; padding: .5rem .75rem; border-bottom: 1px solid var(--border); font-size: .75rem; text-transform: uppercase; letter-spacing: .05em; }
  td { padding: .5rem .75rem; border-bottom: 1px solid var(--border); vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  .mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: .8rem; }
  .truncate { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  /* Badges */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: .7rem; font-weight: 600; text-transform: uppercase; }
  .badge-green { background: rgba(63,185,80,.15); color: var(--green); }
  .badge-yellow { background: rgba(210,153,34,.15); color: var(--yellow); }
  .badge-red { background: rgba(248,81,73,.15); color: var(--red); }
  .badge-blue { background: rgba(88,166,255,.15); color: var(--blue); }
  .badge-muted { background: rgba(139,148,158,.15); color: var(--muted); }

  /* Identity */
  .identity-bar { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: center; font-size: .85rem; margin-bottom: 1rem; padding: .75rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; }
  .identity-bar .label { color: var(--muted); font-size: .75rem; text-transform: uppercase; }
  .identity-bar .value { font-family: 'SF Mono', monospace; font-size: .8rem; }
  .copy-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: .75rem; margin-left: 4px; }
  .copy-btn:hover { color: var(--accent); }

  /* Events log */
  .event-row { padding: .4rem 0; border-bottom: 1px solid var(--border); font-size: .8rem; }
  .event-row:last-child { border-bottom: none; }
  .event-ts { color: var(--muted); font-size: .7rem; font-family: monospace; }
  .event-action { font-weight: 600; color: var(--blue); }
  .event-reason { color: var(--text); }

  /* Empty state */
  .empty { text-align: center; padding: 2rem; color: var(--muted); font-size: .85rem; }

  /* Responsive */
  @media (max-width: 600px) {
    .stats { grid-template-columns: repeat(2, 1fr); }
    .identity-bar { flex-direction: column; gap: .5rem; }
  }

  /* Auto-refresh indicator */
  .auto-refresh { font-size: .7rem; color: var(--muted); }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1><span class="status-dot" id="status-dot"></span><span>Claw</span>Sats Dashboard</h1>
    <div class="header-right">
      <span class="auto-refresh" id="auto-label">Auto-refresh: 10s</span>
      <button id="refresh-btn" onclick="loadStatus()">Refresh</button>
    </div>
  </div>

  <div class="identity-bar" id="identity-bar">
    <div><span class="label">Identity</span><br><span class="value" id="id-key">...</span><button class="copy-btn" onclick="copyId()">copy</button></div>
    <div><span class="label">Chain</span><br><span class="value" id="id-chain">...</span></div>
    <div><span class="label">Endpoint</span><br><span class="value" id="id-endpoint">...</span></div>
    <div><span class="label">Uptime</span><br><span class="value" id="id-uptime">...</span></div>
  </div>

  <div class="stats" id="stats-grid">
    <div class="stat-card"><div class="stat-num" id="s-calls">-</div><div class="stat-label">Calls Served</div></div>
    <div class="stat-card"><div class="stat-num" id="s-callers">-</div><div class="stat-label">Unique Callers</div></div>
    <div class="stat-card"><div class="stat-num" id="s-peers">-</div><div class="stat-label">Known Peers</div></div>
    <div class="stat-card"><div class="stat-num" id="s-caps">-</div><div class="stat-label">Capabilities</div></div>
    <div class="stat-card"><div class="stat-num" id="s-memory">-</div><div class="stat-label">On-Chain Memories</div></div>
    <div class="stat-card"><div class="stat-num" id="s-referrals">-</div><div class="stat-label">Referral Sats</div></div>
  </div>

  <!-- Capabilities -->
  <div class="section">
    <h2><span class="icon">&#9889;</span> Capabilities</h2>
    <table>
      <thead><tr><th>Name</th><th>Price</th><th>Calls</th><th>Description</th></tr></thead>
      <tbody id="cap-table"></tbody>
    </table>
  </div>

  <!-- Peers -->
  <div class="section">
    <h2><span class="icon">&#127760;</span> Known Peers</h2>
    <table>
      <thead><tr><th>Identity</th><th>Endpoint</th><th>Capabilities</th><th>Last Seen</th></tr></thead>
      <tbody id="peer-table"></tbody>
    </table>
    <div class="empty" id="peer-empty" style="display:none;">No peers discovered yet. Discovery sweep runs automatically.</div>
  </div>

  <!-- Brain Jobs -->
  <div class="section">
    <h2><span class="icon">&#129504;</span> Brain Jobs</h2>
    <div style="display:flex;gap:1rem;margin-bottom:.75rem;font-size:.85rem;">
      <span><span class="badge badge-yellow" id="j-pending">0</span> pending</span>
      <span><span class="badge badge-green" id="j-completed">0</span> completed</span>
      <span><span class="badge badge-red" id="j-failed">0</span> failed</span>
      <span><span class="badge badge-blue" id="j-approval">0</span> approval</span>
    </div>
    <table>
      <thead><tr><th>ID</th><th>Capability</th><th>Strategy</th><th>Status</th><th>Created</th></tr></thead>
      <tbody id="job-table"></tbody>
    </table>
    <div class="empty" id="job-empty" style="display:none;">No brain jobs queued.</div>
  </div>

  <!-- Recent Events -->
  <div class="section">
    <h2><span class="icon">&#128220;</span> Recent Decisions</h2>
    <div id="events-list"></div>
    <div class="empty" id="events-empty" style="display:none;">No decision events recorded yet.</div>
  </div>

  <!-- Education -->
  <div class="section">
    <h2><span class="icon">&#127891;</span> Education</h2>
    <div style="font-size:.85rem;">
      <span>Courses completed: <strong id="edu-completed">0</strong></span> &nbsp;|&nbsp;
      <span>Courses available: <strong id="edu-available">0</strong></span>
    </div>
    <div id="edu-list" style="margin-top:.5rem;font-size:.8rem;color:var(--muted);"></div>
  </div>

  <!-- Memory -->
  <div class="section">
    <h2><span class="icon">&#128279;</span> On-Chain Memory</h2>
    <div style="font-size:.85rem;" id="memory-info">Loading...</div>
  </div>
</div>

<script>
var fullIdentity = '';
var refreshTimer = null;

function fmt(n) { return typeof n === 'number' ? n.toLocaleString() : String(n || 0); }
function short(s, n) { return s && s.length > n ? s.substring(0, n) + '...' : s || ''; }
function ago(ts) {
  if (!ts) return '-';
  var d = Date.now() - new Date(ts).getTime();
  if (d < 60000) return Math.floor(d/1000) + 's ago';
  if (d < 3600000) return Math.floor(d/60000) + 'm ago';
  if (d < 86400000) return Math.floor(d/3600000) + 'h ago';
  return Math.floor(d/86400000) + 'd ago';
}
function uptimeFmt(s) {
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s/60) + 'm ' + (s%60) + 's';
  var h = Math.floor(s/3600);
  var m = Math.floor((s%3600)/60);
  return h + 'h ' + m + 'm';
}
function statusBadge(status) {
  var cls = 'badge-muted';
  if (status === 'completed') cls = 'badge-green';
  else if (status === 'pending' || status === 'running') cls = 'badge-yellow';
  else if (status === 'failed') cls = 'badge-red';
  else if (status === 'needs_approval') cls = 'badge-blue';
  return '<span class="badge ' + cls + '">' + status + '</span>';
}

function copyId() {
  if (!fullIdentity) return;
  navigator.clipboard.writeText(fullIdentity).then(function() {
    var btn = document.querySelector('.copy-btn');
    btn.textContent = 'copied!';
    setTimeout(function() { btn.textContent = 'copy'; }, 2000);
  });
}

async function loadStatus() {
  try {
    var res = await fetch('/api/status');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    var d = await res.json();

    // Status dot
    document.getElementById('status-dot').className = 'status-dot online';

    // Identity bar
    fullIdentity = d.identity || '';
    document.getElementById('id-key').textContent = short(d.identity, 24);
    document.getElementById('id-chain').textContent = d.chain || '?';
    document.getElementById('id-endpoint').textContent = short(d.endpoint, 40);
    document.getElementById('id-uptime').textContent = uptimeFmt(d.uptime || 0);

    // Stats
    document.getElementById('s-calls').textContent = fmt(d.reputation?.totalCallsServed);
    document.getElementById('s-callers').textContent = fmt(d.reputation?.uniqueCallers);
    document.getElementById('s-peers').textContent = fmt(d.peerCount);
    document.getElementById('s-caps').textContent = fmt(d.capabilities?.length);
    document.getElementById('s-memory').textContent = fmt(d.memory?.totalRecords || d.memory?.total || 0);
    document.getElementById('s-referrals').textContent = fmt(d.reputation?.referralsEarned);

    // Capabilities table
    var capHtml = '';
    if (d.capabilities && d.capabilities.length > 0) {
      for (var i = 0; i < d.capabilities.length; i++) {
        var c = d.capabilities[i];
        capHtml += '<tr><td class="mono">' + c.name + '</td><td>' + c.pricePerCall + ' sat</td><td>' + fmt(c.callsServed) + '</td><td style="color:var(--muted);font-size:.8rem;">' + short(c.description, 60) + '</td></tr>';
      }
    }
    document.getElementById('cap-table').innerHTML = capHtml;

    // Peers table
    var peerHtml = '';
    var peers = d.peers || [];
    if (peers.length > 0) {
      for (var i = 0; i < Math.min(peers.length, 20); i++) {
        var p = peers[i];
        var caps = (p.capabilities || []).join(', ');
        peerHtml += '<tr><td class="mono truncate">' + short(p.identityKey, 16) + '</td><td class="mono" style="font-size:.75rem;">' + short(p.endpoint, 35) + '</td><td style="font-size:.75rem;color:var(--muted);">' + short(caps, 40) + '</td><td style="font-size:.75rem;">' + ago(p.lastSeenAt) + '</td></tr>';
      }
      document.getElementById('peer-table').innerHTML = peerHtml;
      document.getElementById('peer-empty').style.display = 'none';
    } else {
      document.getElementById('peer-table').innerHTML = '';
      document.getElementById('peer-empty').style.display = 'block';
    }

    // Jobs
    var jobs = d.jobs || {};
    document.getElementById('j-pending').textContent = fmt(jobs.pending);
    document.getElementById('j-completed').textContent = fmt(jobs.completed);
    document.getElementById('j-failed').textContent = fmt(jobs.failed);
    document.getElementById('j-approval').textContent = fmt(jobs.needsApproval);
    var jobHtml = '';
    var recent = jobs.recent || [];
    if (recent.length > 0) {
      for (var i = 0; i < recent.length; i++) {
        var j = recent[i];
        jobHtml += '<tr><td class="mono" style="font-size:.7rem;">' + short(j.id, 12) + '</td><td class="mono">' + j.capability + '</td><td>' + (j.strategy || '-') + '</td><td>' + statusBadge(j.status) + '</td><td style="font-size:.75rem;">' + ago(j.createdAt) + '</td></tr>';
      }
      document.getElementById('job-table').innerHTML = jobHtml;
      document.getElementById('job-empty').style.display = 'none';
    } else {
      document.getElementById('job-table').innerHTML = '';
      document.getElementById('job-empty').style.display = 'block';
    }

    // Events
    var events = d.recentEvents || [];
    if (events.length > 0) {
      var evHtml = '';
      for (var i = 0; i < events.length; i++) {
        var e = events[i];
        evHtml += '<div class="event-row"><span class="event-ts">' + (e.ts || '').substring(11, 19) + '</span> <span class="event-action">' + (e.action || '') + '</span> <span class="event-reason">' + short(e.reason, 80) + '</span></div>';
      }
      document.getElementById('events-list').innerHTML = evHtml;
      document.getElementById('events-empty').style.display = 'none';
    } else {
      document.getElementById('events-list').innerHTML = '';
      document.getElementById('events-empty').style.display = 'block';
    }

    // Education
    var edu = d.education || {};
    document.getElementById('edu-completed').textContent = (edu.coursesCompleted || []).length;
    document.getElementById('edu-available').textContent = fmt(edu.coursesAvailable);
    if (edu.coursesCompleted && edu.coursesCompleted.length > 0) {
      document.getElementById('edu-list').textContent = 'Completed: ' + edu.coursesCompleted.join(', ');
    } else {
      document.getElementById('edu-list').textContent = 'No courses completed yet.';
    }

    // Memory
    var mem = d.memory || {};
    var memHtml = 'Records: <strong>' + fmt(mem.totalRecords || mem.total || 0) + '</strong>';
    if (mem.categories) {
      var cats = Object.keys(mem.categories);
      if (cats.length > 0) memHtml += ' &nbsp;|&nbsp; Categories: ' + cats.join(', ');
    }
    if (mem.masterIndexTxid) {
      memHtml += ' &nbsp;|&nbsp; Master index: <span class="mono" style="font-size:.75rem;">' + short(mem.masterIndexTxid, 16) + '</span>';
    }
    document.getElementById('memory-info').innerHTML = memHtml;

  } catch (err) {
    document.getElementById('status-dot').className = 'status-dot offline';
    console.error('Dashboard fetch failed:', err);
  }
}

// Initial load + auto-refresh
loadStatus();
refreshTimer = setInterval(loadStatus, 10000);
</script>
</body>
</html>
