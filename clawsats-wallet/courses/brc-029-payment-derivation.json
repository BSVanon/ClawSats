{
  "id": "brc-029-payment-derivation",
  "title": "Payment Derivation",
  "level": 2,
  "prerequisites": [
    "bsv-101-what-is-bsv",
    "bsv-102-the-utxo-model",
    "bsv-103-why-micropayments-matter",
    "bsv-104-bsv-vs-other-blockchains"
  ],
  "category": "protocol",
  "summary": "BRC-29 enables fresh payment addresses per transaction using derivationPrefix + derivationSuffix. Prevents address reuse for privacy and security.",
  "content": "# BRC-029: Payment Derivation\n\n## The Problem with Address Reuse\n\nIn traditional Bitcoin systems, reusing the same address for multiple payments links all your transactions together:\n\n- **Privacy loss**: Third parties can track your entire transaction history\n- **UTXO clustering**: All your funds get linked in the blockchain view\n- **Security risks**: If one key is compromised, all funds are at risk\n\nBRC-29 solves this by deriving fresh addresses for every payment.\n\n## Key Derivation Scheme\n\nBRC-29 uses BRC-42 key derivation with two components:\n\n### Derivation Prefix\n\n- **Payment-wide**: Same for all outputs in one payment\n- **Unique per payment**: Generated by the sender\n- **Privacy-preserving**: Different payments aren't linkable\n\n### Derivation Suffix\n\n- **UTXO-specific**: Unique for each output\n- **Unlinkable**: Each output has a different key\n- **Fresh addresses**: No address reuse\n\n## Invoice Number Format\n\nThe invoice number follows this format:\n\n```\n\"2-3241645161d8-<derivationPrefix> <derivationSuffix>\"\n```\n\nWhere:\n- `2` = Security level (counterparty-specific)\n- `3241645161d8` = BRC-29 magic number\n- `<derivationPrefix>` = Payment-wide prefix\n- `<derivationSuffix>` = UTXO-specific suffix\n\n## How It Works\n\n1. **Sender generates prefix**: Unique for this payment\n2. **Sender generates suffix**: Unique for each UTXO\n3. **Sender derives recipient's public key**: Using recipient's identity key + invoice number\n4. **Sender creates P2PKH output**: Locked to the derived public key\n5. **Recipient derives private key**: Using same derivation to unlock funds\n\n## SPV-Compliant\n\nBRC-29 uses BRC-8 transaction envelopes and BRC-9 SPV validation:\n\n- **Envelopes**: Contain transaction + SPV proofs\n- **Validation**: Recipient can verify without downloading full blockchain\n- **Cross-compatible**: Works across all BSV wallets\n\n## Why Fresh Addresses Matter\n\n### Privacy\n\nEach payment uses a new address, so:\n- No transaction linking\n- No balance tracking\n- No spending pattern analysis\n\n### Security\n\nIf one key is compromised:\n- Only that payment is affected\n- Other funds remain safe\n- No cascading failures\n\n### Scalability\n\nFresh addresses enable:\n- Parallel processing\n- Efficient UTXO management\n- No global state bottlenecks\n\n## Detailed Implementation\n\n### Sender Steps\n\n```typescript\nconst derivationPrefix = crypto.randomBytes(16).toString('hex');\nconst derivationSuffix = 'output1';\n\nconst invoiceNumber = `2-3241645161d8-${derivationPrefix} ${derivationSuffix}`;\n\nconst recipientKey = derivePublicKey(senderPrivateKey, invoiceNumber, recipientIdentityKey);\n\nconst script = Script.fromAddress(recipientKey.toAddress());\n```\n\n### Recipient Validation\n\n```typescript\nconst privateKey = derivePrivateKey(recipientPrivateKey, invoiceNumber, senderIdentityKey);\n\n// Verify the transaction output can be unlocked\nconst canUnlock = verifyScript(transaction.outputs[0], privateKey);\n```\n\n## BRC-8 Transaction Envelopes\n\nBRC-29 payments are wrapped in BRC-8 envelopes:\n\n```json\n{\n  \"protocol\": \"3241645161d8\",\n  \"senderIdentityKey\": \"...\",\n  \"derivationPrefix\": \"abc123\",\n  \"transactions\": [\n    {\n      \"envelope\": { /* BRC-8 envelope */ },\n      \"outputs\": {\n        \"0\": { \"suffix\": \"output1\" }\n      }\n    }\n  ]\n}\n```\n\n## SPV Validation with BRC-9\n\nRecipients validate payments using SPV:\n\n- **Merkle proofs**: Verify transaction inclusion\n- **Header validation**: Check proof-of-work\n- **Script verification**: Ensure outputs are spendable\n\n## ClawSats Integration\n\nClawSats uses BRC-29 throughout:\n\n### Capability Payments\n\nEvery paid API call uses fresh derivation:\n\n```typescript\n// Provider generates challenge\nconst challenge = {\n  derivationPrefix: generatePrefix(),\n  requiredOutputs: [{\n    amount: 5000, // 5 sats\n    derivationSuffix: 'payment'\n  }, {\n    amount: 200, // 2 sat fee\n    derivationSuffix: 'fee'\n  }]\n};\n```\n\n### Client Payment\n\n```typescript\n// Client builds transaction with fresh addresses\nconst payment = await buildBRC29Payment(challenge, providerIdentityKey);\n\n// Send with proof\nawait callCapability('echo', { message }, payment);\n```\n\n### Security Benefits\n\n- **Unlinkable payments**: Each call uses new addresses\n- **No address reuse**: Fresh keys every time\n- **Privacy preservation**: No transaction correlation\n\n## Conclusion\n\nBRC-29 enables private, secure micropayments by deriving fresh addresses for every transaction. Combined with BRC-8 envelopes and BRC-9 SPV, it provides a complete payment solution for autonomous agents. ClawSats leverages this for all capability monetization, ensuring privacy and security at scale.",
  "quiz": [
    {
      "question": "BRC-29 uses derivationPrefix + derivationSuffix for fresh addresses",
      "options": [
        "BRC-29 uses derivationPrefix + derivationSuffix for fresh addresses",
        "BRC-29 reuses the same address for all payments",
        "BRC-29 doesn't use key derivation",
        "BRC-29 uses only derivationSuffix"
      ],
      "correctHash": "f21f823068790d08bb3cb465e094391db62900187993899765a63f2178f3e060"
    },
    {
      "question": "Address reuse breaks privacy by linking transactions",
      "options": [
        "Address reuse improves privacy",
        "Address reuse breaks privacy by linking transactions",
        "Address reuse has no privacy impact",
        "Address reuse only affects security"
      ],
      "correctHash": "62607e7a2c25cb48c846327a995dfc50650f62de50f18cbb490ff6ab5090b000"
    },
    {
      "question": "Derivation prefix is payment-wide, suffix is UTXO-specific",
      "options": [
        "Derivation prefix is payment-wide, suffix is UTXO-specific",
        "Derivation prefix is UTXO-specific, suffix is payment-wide",
        "Both are payment-wide",
        "Both are UTXO-specific"
      ],
      "correctHash": "f4bc6583e3df917b490b80ffa49a0e2944ccfa56a8f8e38477209b7fa0837ff8"
    },
    {
      "question": "BRC-29 uses BRC-42 key derivation with security level 2",
      "options": [
        "BRC-29 uses BRC-42 key derivation with security level 2",
        "BRC-29 uses BRC-42 with security level 1",
        "BRC-29 uses BRC-42 with security level 3",
        "BRC-29 doesn't use BRC-42"
      ],
      "correctHash": "023c5389d5487807cdf413ae6493211a8033673fbaa69ef504de08ca6be77980"
    },
    {
      "question": "ClawSats uses BRC-29 for every paid capability call",
      "options": [
        "ClawSats uses BRC-29 for every paid capability call",
        "ClawSats doesn't use BRC-29",
        "ClawSats uses BRC-29 only for free calls",
        "ClawSats uses BRC-29 only for DNS calls"
      ],
      "correctHash": "7815975b34b221c6b93e1d9ece07d12e8792bbe26401b374a498999f3e6948a7"
    }
  ],
  "passingScore": 0.6,
  "teachPrice": 25,
  "version": "1.0.0"
}